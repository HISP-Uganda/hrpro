
# HISP HR System
## Codex CLI Master Prompt File
## Phase A – Online-First
## Stack: Wails v2 + Go 1.22+ + SQLX + golang-migrate + JWT

---

# 1. FOUNDATION PHASE

Goal: Establish project skeleton + DB + migrations.

Prompt:

Implement system foundation:

- Ensure Wails project structure matches requirements.md
- Implement config loader:
    - DB connection string
    - JWT secret
    - Token expiry durations
- Setup SQLX DB connection pool
- Add golang-migrate integration
- Create complete migration set for all tables:
    users
    refresh_tokens
    departments
    employees
    leave_types
    leave_requests
    payroll_batches
    payroll_entries
    audit_logs
- Ensure up/down migration files exist
- Add migration runner for development startup

Deliverables:
- backend/internal/config
- backend/internal/db
- backend/migrations
- Clean build
- Update docs/status.md

---

# 2. AUTHENTICATION (JWT + REFRESH)

Goal: Fully working JWT authentication.

Implement:

## Backend

- users repository (SQLX)
- bcrypt password hashing
- Login function:
    - Validate credentials
    - Generate access token (short-lived)
    - Generate refresh token
    - Store hashed refresh token
- Refresh token rotation:
    - Validate old refresh token
    - Invalidate old
    - Issue new pair
- Logout:
    - Revoke refresh token
- JWT middleware:
    - Validate signature
    - Extract claims
    - Load user
    - Verify is_active
- RBAC middleware:
    - Enforce role-based restrictions

Access token must contain:
- user_id
- username
- role
- expiry

Deliverables:
- internal/auth
- middleware/jwt.go
- middleware/rbac.go
- Update docs/status.md

---

# 3. LOGIN UI + AUTH STATE

Goal: Fully functional login experience.

Frontend:

- Small centered login screen (MUI Card)
- Username + Password fields
- Error handling
- Call login backend function
- Store access token in memory
- Handle refresh flow automatically
- Implement logout
- Prevent shell rendering before auth

Add:
- “Me” function to retrieve authenticated user

Deliver:
- Protected routes using TanStack Router
- Update docs/status.md

---

# 4. MAIN SHELL

Goal: Authenticated UI structure.

Implement:

- Sidebar navigation
- Top bar:
    - Username
    - Role
    - Logout button
- Route-based access visibility
- Hide unauthorized menu items
- Protect all routes

Deliver:
- Clean shell layout
- Update docs/status.md

---

# 5. EMPLOYEES MODULE

Backend:

- SQLX repository
- Service layer
- CRUD operations:
    - CreateEmployee
    - UpdateEmployee
    - DeleteEmployee
    - GetEmployee
    - ListEmployees (with pagination + search)
- Validate required fields
- Ensure department_id integrity

Frontend:

- Employee list table
- Search bar
- Create/Edit dialog
- Delete confirmation

Deliver:
- End-to-end employee management
- Update docs/status.md

---

# 6. DEPARTMENTS MODULE

Backend:

- CRUD operations
- Enforce rule:
    - Cannot delete department with assigned employees

Frontend:

- Department list page
- Create/Edit dialogs

Deliver:
- Department management working
- Update docs/status.md

---

# 7. LEAVE MODULE (UPDATED TO MATCH requirements.md 3.4)

Implement Leave Management end-to-end per docs/requirements.md Section 3.4.

Backend (Go + SQLX):
- leave_types CRUD:
  - create, update, deactivate/list active
- leave_locked_dates:
  - admin can lock/unlock dates (global restricted dates)
  - list locked dates (for planner + validation)
- leave_entitlements:
  - per employee per year: total_days, reserved_days (defaults from employee config are acceptable for MVP)
- leave_requests:
  - ApplyLeave (staff for self; admin can apply on behalf):
    - fields: leave_type_id, start_date, end_date, optional reason
    - server calculates working_days excluding weekends
    - reject if end_date < start_date
    - reject if range contains 0 working days
    - reject if any locked date falls within the requested working days
    - reject if overlaps any APPROVED leave for same employee
    - reject if working_days > available balance where:
      available = total - reserved - (pending + approved days)
  - ApproveLeave (admin/hr):
    - enforce status transition Pending -> Approved
  - RejectLeave (admin/hr):
    - enforce status transition Pending -> Rejected
  - CancelLeave:
    - staff can cancel Pending only
    - admin/hr can cancel Approved (optional for MVP if already in spec)
  - Master-only: edit/delete any leave record (including approved)

- Leave balance endpoints:
  - GetMyLeaveBalance(year)
  - Admin: GetLeaveBalance(employee_id, year)
  - LeaveBalancesReport (filter by department optional)
- Leave reports:
  - LeaveReport: filter by date range, department, employee, leave type, status
  - Provide CSV export response for reports (or a reusable exporter)

Attendance integration:
- Endpoint to convert an absence record -> approved leave (1 day) with balance check
  (If attendance module not implemented yet, stub the integration and leave TODO + tests.)

Frontend (Wails React + MUI + TypeScript):
- Leave Types page (admin):
  - list/add/edit/activate/deactivate
- Leave Planner page:
  - year view calendar grid
  - staff: schedule/unschedule personal plans (optional MVP)
  - admin: lock/unlock dates (required)
- Apply Leave form:
  - start/end date inputs
  - auto-calc days excluding weekends
  - inline errors (locked dates, insufficient balance, invalid range)
- Requests & History:
  - staff: see own requests + status chips; cancel pending
  - admin/hr: see all pending; approve/reject buttons; filters
  - master: edit/delete controls

Testing (required):
- Unit tests for working-days calculation:
  - excludes weekends
  - handles same-day range
  - handles invalid ranges
  - handles locked-date collisions
- Unit tests for balance validation:
  - counts pending + approved
  - respects reserved days
- Minimal API tests for apply/approve/reject.

Docs:
- Update docs/status.md as items complete
- Add short implementation notes in docs/notes/leave.md
- Do not change docs/requirements.md unless contradictions are found; if so, propose a minimal patch.

---

# 8. PAYROLL MODULE

Goal: Implement batch-based payroll per docs/requirements.md 3.5 (Draft → Approved → Locked),
with server-side gross/net calculations and strict RBAC.

Backend:

- Data model (must match requirements.md 3.5):
  - payroll_batches:
      - id
      - month (YYYY-MM)
      - status (Draft | Approved | Locked)
      - created_by, created_at
      - approved_by, approved_at (nullable)
      - locked_at (nullable)
      - Enforce: only one batch per month
  - payroll_entries:
      - id
      - batch_id
      - employee_id
      - base_salary
      - allowances_total (numeric)
      - deductions_total (numeric)
      - tax_total (numeric)
      - gross_pay (computed)
      - net_pay (computed)
      - created_at, updated_at

- Core operations:
  - CreateBatch(month YYYY-MM):
      - status = Draft
      - reject if month already exists
  - GenerateEntries(batch_id) (transactional):
      - only allowed if batch.status == Draft
      - for each active employee:
          - base_salary from employee record
          - set allowances_total=0, deductions_total=0, tax_total=0
          - compute gross/net server-side and persist
      - must run in a DB transaction; rollback on any failure
      - allow regenerate while Draft (either delete+recreate entries transactionally OR upsert safely)
  - UpdateEntryAmounts(entry_id, allowances_total, deductions_total, tax_total):
      - only if parent batch.status == Draft
      - recompute gross_pay and net_pay server-side and persist
  - ApproveBatch(batch_id):
      - only if status == Draft
      - set status=Approved, approved_by/approved_at
  - LockBatch(batch_id):
      - only if status == Approved
      - set status=Locked, locked_at
  - Enforce immutability:
      - no edits/regeneration/export rules must follow batch status rules

- Calculation rules (server-side, persisted):
  - gross_pay = base_salary + allowances_total
  - net_pay   = gross_pay - deductions_total - tax_total

- Export:
  - ExportBatchCSV(batch_id):
      - allowed only if status in (Approved, Locked)
      - columns: Employee Name, Base Salary, Allowances, Deductions, Tax, Gross Pay, Net Pay

- RBAC:
  - Finance Officer + Admin: manage payroll (create/generate/edit draft/approve/lock/export)
  - Others: no payroll access
  - If your RBAC currently only supports admin, extend roles to include finance_officer and enforce.

- API surface (if using HTTP layer) OR Wails bindings:
  - ListBatches(filter by month/status)
  - GetBatch(batch_id) + entries
  - CreateBatch
  - GenerateEntries
  - UpdateEntryAmounts
  - ApproveBatch
  - LockBatch
  - ExportBatchCSV

- Testing (required):
  - unit tests for calculation (gross/net)
  - unit tests for status transition rules
  - integration test: generate entries is transactional (fail one insert -> rollback)

Frontend (Wails React + MUI + TypeScript):

- Payroll Batches page:
  - list batches (month, status)
  - create batch (month picker)
  - open batch detail
- Batch Detail page:
  - entries table (employee, base, allowances, deductions, tax, gross, net)
  - inline edit allowances/deductions/tax ONLY when Draft
  - Approve button (Draft only)
  - Lock button (Approved only)
  - CSV export button (Approved/Locked only)
  - show status badge + audit fields (created/approved/locked timestamps)
- Access control:
  - Payroll menu and routes visible only to Finance/Admin

Deliver:
- Complete payroll lifecycle implemented end-to-end (DB → backend → UI)
- Server-side persisted calculations
- RBAC enforced
- CSV export working
- Update docs/status.md
- Add docs/notes/payroll.md with endpoints/bindings and key rules

---

# 9. USER MANAGEMENT

Backend:

- CreateUser
- ResetPassword
- Activate/Deactivate
- ListUsers

Frontend:

- Users page (Admin only)
- Create dialog
- Status toggle
- Reset password dialog

Deliver:
- Admin user control
- Update docs/status.md

---

# 10. AUDIT LOGGING

Backend:

- Helper to record audit events
- Automatically log:
    - Login success/failure
    - Token refresh
    - Leave approvals
    - Payroll batch create/approve/lock
    - Payroll entry update
    - User changes

Optional:
- Admin audit log viewer page

Deliver:
- Audit fully integrated
- Update docs/status.md

---

# 11. HARDENING PHASE

Perform full system audit:

- Ensure all SQL queries parameterized
- Validate RBAC coverage
- Validate refresh token revocation
- Improve error handling
- Improve logging clarity
- Remove dead code
- Ensure cross-platform builds
- Add minimal service-layer tests

Deliver:
- Clean, production-ready state
- Update docs/status.md

---

# LOW CONTEXT / SESSION RESET

If context becomes low:

1. Read docs/requirements.md
2. Read docs/status.md
3. Summarize current state
4. Continue next milestone
5. Avoid rewriting completed modules

---

# END

